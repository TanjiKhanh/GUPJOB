// Prisma schema for GUPJOB Roadmap Engine (Postgres)
// Includes: Department, Course, Roadmap, RoadmapNode, RoadmapEdge,
// UserRoadmap, UserRoadmapNode, VerificationSubmission and a minimal User model.
// Adjust User model to match your existing auth schema if you already have one.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  STUDENT
  MENTOR
  ADMIN
  COMPANY
}

enum CourseType {
  BASIC
  JOB
}

enum RoadmapNodeStatus {
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
  VERIFIED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  name         String?
  password     String?
  role         Role       @default(STUDENT)
  department   Department? @relation(name: "DepartmentMentors", fields: [departmentId], references: [id])
  departmentId Int?
  rating       Float?     @default(0)

  // refresh Token
  refreshTokens RefreshToken[]

  // relations
  userRoadmaps UserRoadmap[]
  verificationsSubmitted VerificationSubmission[] @relation("submitter")
  verificationsReviewed  VerificationSubmission[] @relation("reviewer")
  verifiedNodes UserRoadmapNode[] @relation("verifier")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model RefreshToken {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  tokenHash  String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revoked    Boolean  @default(false)
  userAgent  String?
  ip         String?

  @@index([userId])
}

model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  courses     Course[]
  mentors     User[]   @relation(name: "DepartmentMentors")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Course {
  id           Int        @id @default(autoincrement())
  slug         String     @unique
  title        String
  description  String?
  type         CourseType
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId Int?
  structure    Json?      // visual layout / groups / viewport
  // relations
  roadmaps     Roadmap[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([departmentId])
}

model Roadmap {
  id          Int           @id @default(autoincrement())
  slug        String        @unique
  title       String
  description String?
  structure   Json?         // coordinates, visual layout (stored for frontend)
  course      Course?       @relation(fields: [courseId], references: [id])
  courseId    Int?
  // relations
  nodes       RoadmapNode[]
  edges       RoadmapEdge[]
  userRoadmaps UserRoadmap[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([courseId])
}

model RoadmapNode {
  id         Int     @id @default(autoincrement())
  roadmap    Roadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  roadmapId  Int
  nodeKey    String
  title      String
  summary    String?
  contentMd  String?
  isRequired Boolean @default(true)
  metadata   Json?
  coords     Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([roadmapId, nodeKey])
  @@index([roadmapId])
}

model RoadmapEdge {
  id             Int            @id @default(autoincrement())
  roadmap        Roadmap        @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  roadmapId      Int
  sourceKey      String
  targetKey      String

  createdAt      DateTime       @default(now())

  @@index([roadmapId, sourceKey])
  @@index([roadmapId, targetKey])
}

model UserRoadmap {
  id         Int               @id @default(autoincrement())
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  roadmap    Roadmap           @relation(fields: [roadmapId], references: [id])
  roadmapId  Int
  title      String
  slug       String?
  structure  Json?             // user-customized layout/coords
  nodes      UserRoadmapNode[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([userId, roadmapId])
  @@index([userId])
  @@index([roadmapId])
}

model UserRoadmapNode {
  id                   Int                @id @default(autoincrement())
  userRoadmap          UserRoadmap        @relation(fields: [userRoadmapId], references: [id], onDelete: Cascade)
  userRoadmapId        Int
  nodeKey              String
  title                String?
  status               RoadmapNodeStatus  @default(AVAILABLE)
  startedAt            DateTime?
  completedAt          DateTime?
  verifiedAt           DateTime?
  verifier             User?              @relation("verifier", fields: [verifierId], references: [id])
  verifierId           Int?
  positionOverride     Json?
  userNotesMd          String?
  verificationRequired Boolean            @default(false)
  submissions          VerificationSubmission[] @relation("nodeSubmissions")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@unique([userRoadmapId, nodeKey])
  @@index([userRoadmapId])
  @@index([verifierId])
  @@index([status])
}

model VerificationSubmission {
  id                    Int       @id @default(autoincrement())
  userRoadmapNode       UserRoadmapNode @relation(fields: [userRoadmapNodeId], references: [id], onDelete: Cascade, name: "nodeSubmissions")
  userRoadmapNodeId     Int
  submitter             User      @relation("submitter", fields: [submitterId], references: [id])
  submitterId           Int
  description           String?
  evidence              Json?
  status                SubmissionStatus @default(PENDING)
  reviewer              User?     @relation("reviewer", fields: [reviewerId], references: [id])
  reviewerId            Int?
  reviewerComment       String?
  createdAt             DateTime  @default(now())
  reviewedAt            DateTime?

  @@index([status])
  @@index([submitterId])
  @@index([reviewerId])
}