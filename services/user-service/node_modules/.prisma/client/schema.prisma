// User service schema
datasource db {
  provider = "postgresql"
  url      = env("USER_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RoadmapNodeStatus {
  AVAILABLE    // Default state if no record exists
  IN_PROGRESS  // User clicked "Start"
  COMPLETED    // User clicked "Finish"
  SKIPPED      // User marked "I know this"
}

model UserRoadmap {
  id              Int      @id @default(autoincrement())
  userId          Int      
  masterRoadmapId Int      // Required link to Admin Service
  
  title           String   // Cached for display in dashboard lists
  slug            String?  // Cached for easy URL generation

  // ‚ö° PROGRESS CACHE
  // We snapshot 'totalNodes' at enrollment so we can calculate % without calling Admin Service constantly
  progressPercent Int      @default(0) 
  totalNodes      Int      @default(0) 
  completedNodes  Int      @default(0) 

  // üìÖ GOALS
  startDate       DateTime @default(now())
  targetDate      DateTime? 

  // NO 'structure' field here - layout always comes from Admin
  nodes           UserRoadmapNode[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([masterRoadmapId])
  @@unique([userId, masterRoadmapId]) // One enrollment per roadmap per user
}

model UserRoadmapNode {
  id               Int               @id @default(autoincrement())
  userRoadmapId    Int
  userRoadmap      UserRoadmap       @relation(fields: [userRoadmapId], references: [id], onDelete: Cascade)
  
  nodeKey          String            // The critical link to the Admin Node ID
  
  // üö¶ STATE (Overlay)
  status           RoadmapNodeStatus @default(AVAILABLE)
  
  // üìù NOTEBOOK (Overlay)
  userNotesMd      String?           
  userResources    Json?             
  
  // ‚è±Ô∏è ANALYTICS
  startedAt        DateTime?
  completedAt      DateTime?
  timeSpentMinutes Int               @default(0) 
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@unique([userRoadmapId, nodeKey]) 
  @@index([userRoadmapId])
}