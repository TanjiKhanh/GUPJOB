// --------------------------------------------------------
// USER SERVICE SCHEMA
// This database manages user-specific progress, enrollment, and personalization.
// It DOES NOT store the roadmap structure (nodes/edges layout), which lives in Admin Service.
// --------------------------------------------------------

datasource db {
  provider = "postgresql"
  url      = env("USER_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ğŸš¦ Status Enum for a specific node in a roadmap
enum RoadmapNodeStatus {
  AVAILABLE    // Default state (implied if no record exists)
  IN_PROGRESS  // User has clicked "Start" on a topic
  COMPLETED    // User has finished the topic
  SKIPPED      // User marked "I already know this"
  LOCKED       // Optional: Enforce linear progression
}

// ğŸ—ºï¸ User Roadmap Container
// This acts as the "Enrollment Record". It caches high-level stats.
model UserRoadmap {
  id              Int      @id @default(autoincrement())
  userId          Int      // Foreign Key to Auth Service (Logical Link)
  masterRoadmapId Int      // Foreign Key to Admin Service (Logical Link)
  
  // ğŸ·ï¸ Cache these for fast Dashboard display without fetching from Admin Service
  title           String   
  slug            String?  

  // âš¡ PROGRESS CACHE (Snapshot Strategy)
  // We store 'totalNodes' at the moment of enrollment.
  // This allows us to calculate % progress instantly: (completedNodes / totalNodes) * 100
  progressPercent Int      @default(0) 
  totalNodes      Int      @default(0) 
  completedNodes  Int      @default(0) 

  // ğŸ“… GOALS & PERSONALIZATION
  startDate       DateTime @default(now())
  targetDate      DateTime? // User set deadline: "I want to finish by X date"
  
  // ğŸ”— Relations
  // Nodes are "Lazy Loaded". We only create rows here when a user interacts with a node.
  nodes           UserRoadmapNode[]
  
  // ğŸ•’ Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // ğŸ” Indexes for performance
  @@index([userId])
  @@index([masterRoadmapId])
  
  // ğŸ›‘ Constraints: A user can only enroll in a specific roadmap once
  @@unique([userId, masterRoadmapId]) 
}

// ğŸ“ Node Interaction Overlay
// Stores ONLY the user's specific data for a node (Status, Notes, Time).
// Coordinate data (x, y) and Content (Description, Video) live in Admin Service.
model UserRoadmapNode {
  id               Int               @id @default(autoincrement())
  
  // ğŸ”— Relation to Parent Roadmap
  userRoadmapId    Int
  userRoadmap      UserRoadmap       @relation(fields: [userRoadmapId], references: [id], onDelete: Cascade)
  
  // ğŸ”‘ The Critical Link
  // This matches the 'nodeKey' string from the Admin Service JSON (e.g., "react-hooks", "arrays-101")
  nodeKey          String            
  
  // ğŸš¦ STATE (The Overlay)
  status           RoadmapNodeStatus @default(AVAILABLE)
  
  // ğŸ“ DIGITAL NOTEBOOK
  userNotesMd      String?           // Markdown notes written by the user
  userResources    Json?             // List of extra links user saved: [{ title: "My Fav Blog", url: "..." }]
  
  // â±ï¸ ANALYTICS & METRICS
  startedAt        DateTime?         // When did they switch status to IN_PROGRESS?
  completedAt      DateTime?         // When did they switch status to COMPLETED?
  timeSpentMinutes Int               @default(0) // Manual log or auto-timer accumulation
  
  // â­ FEEDBACK (Optional)
  difficultyRating Int?              // 1-5 Scale: How hard was this topic for you?

  // ğŸ“ POSITION OVERRIDE (Optional)
  // If you want to allow users to drag nodes around and save their own layout
  // positionOverride Json?          // { x: 500, y: 200 }

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // ğŸ›‘ Constraints: One status record per node per enrollment
  @@unique([userRoadmapId, nodeKey]) 
  
  // ğŸ” Index for fast lookups when loading a full roadmap
  @@index([userRoadmapId])
}