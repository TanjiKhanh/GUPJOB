import { ValidationPipe, Logger } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import * as cookieParser from 'cookie-parser';
import { AppModule } from './src/app.module';

import { PrismaClientExceptionFilter } from './src/filter/prisma-exception.filter';

import { AllExceptionsFilter } from './src/filter/all-exceptions.filter';

import { ResponseInterceptor } from './src/filter/response.interceptor';;

async function bootstrap() {
  const logger = new Logger('Bootstrap');
  const app = await NestFactory.create(AppModule);

  // 1. CẤU HÌNH CORS (Quan trọng cho Cookie)
  app.enableCors({
    // URL of Frontend (Ví dụ: http://localhost:5173 cho Vite)
    origin: ['http://localhost:5173', 'http://localhost:3000'], 
    credentials: true, // REQUIRED: To allow sending/receiving Cookies (HttpOnly)
    methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
  });

  // 2. MIDDLEWARE
  app.use(cookieParser());

  // 3. GLOBAL PIPES (Validation)
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true, 
      transform: true, 
      transformOptions: { enableImplicitConversion: true },
      forbidNonWhitelisted: true, 
    }),
  );

  app.useGlobalFilters(new PrismaClientExceptionFilter(), new AllExceptionsFilter());
  app.useGlobalInterceptors(new ResponseInterceptor());

  const port = process.env.PORT || 3001; // Auth Service 

  // '0.0.0.0' This helps Docker containers receive requests from outside.
  await app.listen(port, '0.0.0.0');

  logger.log(`Auth Service is running on: http://localhost:${port}`);
}
bootstrap();